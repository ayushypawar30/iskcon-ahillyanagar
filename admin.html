<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | ISKCON Ahilyanagar</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f8fafc; }
        .admin-navbar { background: white; border-bottom: 1px solid #e2e8f0; padding: 1rem 0; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .admin-container { max-width: 1200px; margin: 40px auto; padding: 0 20px; }
        
        .dashboard-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 24px; margin-bottom: 40px; }
        .stat-card { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
        .stat-card h3 { font-size: 0.9rem; color: #64748b; margin-bottom: 8px; font-family: 'Inter', sans-serif; text-transform: uppercase; letter-spacing: 0.05em; }
        .stat-card .value { font-size: 2rem; font-weight: 700; color: var(--primary-color); }
        
        .dashboard-section { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; margin-bottom: 40px; overflow: hidden; }
        .section-header { padding: 20px 24px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; background-color: #f8fafc; }
        .section-header h2 { margin: 0; font-size: 1.25rem; color: #1e293b; font-family: 'Playfair Display', serif; }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 16px 24px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        th { background-color: #f1f5f9; font-weight: 600; color: #475569; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #f8fafc; }
        
        .badge { padding: 4px 10px; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; display: inline-block; }
        .badge-success { background-color: #dcfce7; color: #166534; }
        .badge-pending { background-color: #fef9c3; color: #854d0e; }
        
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f1f5f9; z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 40px; border-radius: 16px; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); width: 100%; max-width: 400px; text-align: center; }
    </style>
</head>
<body>

    <!-- Login Screen -->
    <div id="login-screen">
        <div class="login-box">
            <div style="font-size: 3rem; color: var(--primary-color); margin-bottom: 20px;"><i class="fas fa-shield-alt"></i></div>
            <h2 style="margin-bottom: 10px;">Admin Access</h2>
            <p style="color: #64748b; margin-bottom: 30px;">Please authenticate to view dashboard</p>
            <input type="password" id="password-input" placeholder="Enter Password" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; margin-bottom: 20px; font-size: 1rem;">
            <button onclick="checkLogin()" class="btn" style="width: 100%;">Access Dashboard</button>
            <p id="login-error" style="color: #ef4444; display: none; margin-top: 15px; font-size: 0.9rem;">Incorrect password</p>
            <p style="margin-top: 20px; font-size: 0.8rem; color: #94a3b8;">(Password: admin123)</p>
        </div>
    </div>

    <!-- Dashboard Content -->
    <div id="dashboard-content" style="display: none;">
        <nav class="admin-navbar">
            <div class="container" style="display: flex; justify-content: space-between; align-items: center;">
                <div class="logo"><i class="fas fa-om"></i> ISKCON Admin</div>
                <div style="display: flex; gap: 15px;">
                    <button onclick="document.getElementById('orders-section').scrollIntoView({behavior: 'smooth'})" class="btn btn-secondary" style="border-color: #3b82f6; color: #3b82f6; font-size: 0.9rem; padding: 8px 16px;">View Orders</button>
                    <button onclick="exportToCSV()" class="btn btn-secondary" style="border-color: #16a34a; color: #16a34a; font-size: 0.9rem; padding: 8px 16px;"><i class="fas fa-file-excel"></i> Export to Excel</button>
                    <button onclick="generateTestData()" class="btn btn-secondary" style="border-color: #cbd5e1; color: #475569; font-size: 0.9rem; padding: 8px 16px;">Generate Test Data</button>
                    <button onclick="logout()" class="btn btn-secondary" style="border-color: #cbd5e1; color: #475569; font-size: 0.9rem; padding: 8px 16px;">Logout</button>
                </div>
            </div>
        </nav>

        <div class="admin-container">
            <div class="dashboard-stats">
                <div class="stat-card">
                    <h3>Total Donations</h3>
                    <div class="value" id="total-donations">₹0</div>
                </div>
                <div class="stat-card">
                    <h3>Messages</h3>
                    <div class="value" id="total-messages">0</div>
                </div>
                <div class="stat-card">
                    <h3>Subscribers</h3>
                    <div class="value" id="total-subscribers">0</div>
                </div>
            </div>

            <!-- Donation Breakdown -->
            <h3 style="margin-bottom: 20px; color: #64748b; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.05em;">Donation Breakdown</h3>
            <div class="dashboard-stats" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom: 40px;">
                <div class="stat-card" style="border-left: 4px solid #f59e0b;">
                    <h3>Construction</h3>
                    <div class="value" id="total-construction" style="font-size: 1.5rem; color: #1e293b;">₹0</div>
                </div>
                <div class="stat-card" style="border-left: 4px solid #10b981;">
                    <h3>Food for Life</h3>
                    <div class="value" id="total-food" style="font-size: 1.5rem; color: #1e293b;">₹0</div>
                </div>
                <div class="stat-card" style="border-left: 4px solid #3b82f6;">
                    <h3>Goshala</h3>
                    <div class="value" id="total-goshala" style="font-size: 1.5rem; color: #1e293b;">₹0</div>
                </div>
                <div class="stat-card" style="border-left: 4px solid #6366f1;">
                    <h3>General</h3>
                    <div class="value" id="total-general" style="font-size: 1.5rem; color: #1e293b;">₹0</div>
                </div>
            </div>

            <!-- Donations Table -->
            <div class="dashboard-section">
                <div class="section-header">
                    <h2>Recent Donations</h2>
                    <button onclick="window.db.clearDonations(); loadData();" style="color: #ef4444; background: none; border: none; cursor: pointer; font-size: 0.85rem;">Clear History</button>
                </div>
                <div style="overflow-x: auto;">
                    <table id="donation-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Donor</th>
                                <th>Purpose</th>
                                <th>Amount</th>
                                <th>Email</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- ... -->

            <script>
                // ...
                const donationBody = document.querySelector('#donation-table tbody');
                donationBody.innerHTML = donations.map(d => `
                    <tr>
                        <td>${d.date}</td>
                        <td><div style="font-weight: 600; color: #1e293b;">${d.donor_name || d.donorName || 'Anonymous'}</div></td>
                        <td><span class="badge badge-pending" style="color: #333; background: #f1f5f9;">${d.purpose || 'General'}</span></td>
                        <td><div style="font-weight: 600; color: var(--primary-color);">₹${d.amount}</div></td>
                        <td>${d.email}</td>
                        <td><span class="badge badge-success">${d.status || 'Completed'}</span></td>
                    </tr>
                `).join('') || '<tr><td colspan="6" style="text-align:center; color: #94a3b8; padding: 30px;">No donations recorded yet</td></tr>';
            </script>

            <!-- Messages Table -->
            <div class="dashboard-section">
                <div class="section-header">
                    <h2>Contact Messages</h2>
                    <button onclick="window.db.clearContacts(); loadData();" style="color: #ef4444; background: none; border: none; cursor: pointer; font-size: 0.85rem;">Clear Messages</button>
                </div>
                <div style="overflow-x: auto;">
                    <table id="contact-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Message</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Orders Table -->
            <div class="dashboard-section" id="orders-section">
                <div class="section-header">
                    <h2>Store Orders</h2>
                    <button onclick="window.db.clearOrders(); loadData();" style="color: #ef4444; background: none; border: none; cursor: pointer; font-size: 0.85rem;">Clear Orders</button>
                </div>
                <div style="overflow-x: auto;">
                    <table id="orders-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Order ID</th>
                                <th>Customer</th>
                                <th>Items</th>
                                <th>Total</th>
                                <th>Payment</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Subscribers Table -->
            <div class="dashboard-section">
                <div class="section-header">
                    <h2>Newsletter Subscribers</h2>
                    <button onclick="window.db.clearSubscribers(); loadData();" style="color: #ef4444; background: none; border: none; cursor: pointer; font-size: 0.85rem;">Clear List</button>
                </div>
                <table id="sub-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Email</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        </div>
        
        <!-- Debug Area -->
        <div style="margin-top: 20px; padding: 20px; background: #eee; border-radius: 8px; font-family: monospace; font-size: 0.8rem; color: #333;">
            <h4>Debug Info (If data is missing, check here)</h4>
            <div id="debug-output">Loading...</div>
            <button onclick="forceReload()" style="margin-top: 10px; padding: 5px 10px;">Force Reload Data</button>
        </div>
    </div>

    <script src="js/database.js"></script>
    <script>
        // --- Login Logic ---
        function checkLogin() {
            const pass = document.getElementById('password-input').value;
            if (pass === 'admin123') {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('dashboard-content').style.display = 'block';
                loadData();
            } else {
                document.getElementById('login-error').style.display = 'block';
            }
        }

        function logout() {
            location.reload();
        }

        // --- Data Loading ---
        async function loadData() {
            if (!window.db) {
                document.getElementById('debug-output').textContent = 'Error: Database script not loaded!';
                return;
            }

            document.getElementById('debug-output').textContent = 'Fetching data from server...';

            try {
                // Donations
                const donations = await window.db.getDonations();
                // API returns DESC, so no need to reverse
                
                const totalAmount = donations.reduce((sum, d) => sum + parseFloat(d.amount || 0), 0);
                document.getElementById('total-donations').textContent = '₹' + totalAmount.toLocaleString();

                // Calculate Breakdown
                const constructionTotal = donations.filter(d => (d.purpose || '').includes('Construction')).reduce((sum, d) => sum + parseFloat(d.amount || 0), 0);
                const foodTotal = donations.filter(d => (d.purpose || '').includes('Food')).reduce((sum, d) => sum + parseFloat(d.amount || 0), 0);
                const goshalaTotal = donations.filter(d => (d.purpose || '').includes('Goshala')).reduce((sum, d) => sum + parseFloat(d.amount || 0), 0);
                const generalTotal = donations.filter(d => (d.purpose || '').includes('General')).reduce((sum, d) => sum + parseFloat(d.amount || 0), 0);

                document.getElementById('total-construction').textContent = '₹' + constructionTotal.toLocaleString();
                document.getElementById('total-food').textContent = '₹' + foodTotal.toLocaleString();
                document.getElementById('total-goshala').textContent = '₹' + goshalaTotal.toLocaleString();
                document.getElementById('total-general').textContent = '₹' + generalTotal.toLocaleString();
                
                const donationBody = document.querySelector('#donation-table tbody');
                donationBody.innerHTML = donations.map(d => `
                    <tr>
                        <td>${d.date}</td>
                        <td><div style="font-weight: 600; color: #1e293b;">${d.donor_name || d.donorName || 'Anonymous'}</div></td>
                        <td><span class="badge badge-pending" style="color: #333; background: #f1f5f9;">${d.purpose || 'General'}</span></td>
                        <td><div style="font-weight: 600; color: var(--primary-color);">₹${d.amount}</div></td>
                        <td>${d.email}</td>
                        <td><span class="badge badge-success">${d.status || 'Completed'}</span></td>
                    </tr>
                `).join('') || '<tr><td colspan="6" style="text-align:center; color: #94a3b8; padding: 30px;">No donations recorded yet</td></tr>';

                // Contacts
                const contacts = await window.db.getContacts();
                // API returns DESC
                document.getElementById('total-messages').textContent = contacts.length;
                
                const contactBody = document.querySelector('#contact-table tbody');
                contactBody.innerHTML = contacts.map(c => `
                    <tr>
                        <td>${c.date}</td>
                        <td><div style="font-weight: 600; color: #1e293b;">${c.name}</div></td>
                        <td>${c.email}</td>
                        <td style="max-width: 300px; line-height: 1.5;">${c.message}</td>
                    </tr>
                `).join('') || '<tr><td colspan="4" style="text-align:center; color: #94a3b8; padding: 30px;">No messages received</td></tr>';

                // Subscribers
                const subs = await window.db.getSubscribers();
                // API returns DESC
                document.getElementById('total-subscribers').textContent = subs.length;
                
                const subBody = document.querySelector('#sub-table tbody');
                subBody.innerHTML = subs.map(s => `
                    <tr>
                        <td>${s.date}</td>
                        <td>${s.email}</td>
                    </tr>
                `).join('') || '<tr><td colspan="2" style="text-align:center; color: #94a3b8; padding: 30px;">No subscribers yet</td></tr>';

                // Orders
                const orders = await window.db.getOrders();
                const ordersBody = document.querySelector('#orders-table tbody');
                
                ordersBody.innerHTML = orders.map(o => {
                    let itemsSummary = 'No items';
                    try {
                        const items = JSON.parse(o.items || '[]');
                        itemsSummary = items.map(i => `${i.name} (x${i.quantity})`).join(', ');
                    } catch (e) { itemsSummary = 'Error parsing items'; }

                    return `
                    <tr>
                        <td>${o.date}</td>
                        <td><span style="font-family: monospace; font-weight: bold;">${o.order_id}</span></td>
                        <td>
                            <div style="font-weight: 600; color: #1e293b;">${o.customer_name}</div>
                            <div style="font-size: 0.8rem; color: #64748b;">${o.city}</div>
                        </td>
                        <td style="max-width: 250px; font-size: 0.9rem;">${itemsSummary}</td>
                        <td><div style="font-weight: 600; color: var(--primary-color);">₹${o.total_amount}</div></td>
                        <td><span class="badge ${o.payment_mode === 'cod' ? 'badge-pending' : 'badge-success'}">${o.payment_mode.toUpperCase()}</span></td>
                        <td>
                            <select onchange="updateStatus('${o.order_id}', this.value)" style="padding: 4px; border-radius: 4px; border: 1px solid #cbd5e1; font-size: 0.85rem;">
                                <option value="Pending" ${o.status === 'Pending' ? 'selected' : ''}>Pending</option>
                                <option value="Shipped" ${o.status === 'Shipped' ? 'selected' : ''}>Shipped</option>
                                <option value="Delivered" ${o.status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                            </select>
                        </td>
                    </tr>
                    `;
                }).join('') || '<tr><td colspan="7" style="text-align:center; color: #94a3b8; padding: 30px;">No orders placed yet</td></tr>';


                document.getElementById('debug-output').textContent = 'Data loaded successfully from Python Server.';
            } catch (err) {
                console.error(err);
                document.getElementById('debug-output').textContent = 'Error loading data: ' + err.message;
            }
        }

        async function updateStatus(orderId, newStatus) {
            try {
                const response = await fetch(`/api/orders/${orderId}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                
                if (response.ok) {
                    // alert('Status updated!'); // Optional: too many alerts can be annoying
                    // Reload to reflect changes if needed, or just let it stay
                } else {
                    alert('Failed to update status');
                }
            } catch (err) {
                console.error(err);
                alert('Error updating status');
            }
        }

        function forceReload() {
            location.reload();
        }

        // --- Export to CSV ---
        async function exportToCSV() {
            try {
                const donations = await window.db.getDonations();
                if (!donations || donations.length === 0) {
                    alert('No data to export!');
                    return;
                }

                // Define headers
                const headers = ['Date', 'Order ID', 'Donor Name', 'Email', 'Amount', 'Purpose', 'Status'];
                
                // Convert to CSV string
                const csvRows = [headers.join(',')];
                
                donations.forEach(d => {
                    const row = [
                        `"${d.date}"`,
                        `"${d.order_id || d.orderId || ''}"`,
                        `"${d.donor_name || d.donorName || ''}"`,
                        `"${d.email}"`,
                        d.amount,
                        `"${d.purpose || 'General'}"`,
                        `"${d.status || 'Completed'}"`
                    ];
                    csvRows.push(row.join(','));
                });

                const csvString = csvRows.join('\n');
                
                // Create download link
                const blob = new Blob([csvString], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.setAttribute('hidden', '');
                a.setAttribute('href', url);
                a.setAttribute('download', 'iskcon_donations.csv');
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } catch (err) {
                console.error('Export failed:', err);
                alert('Failed to export data');
            }
        }

        // --- Test Data Generator ---
        async function generateTestData() {
            if(confirm('Generate sample data?')) {
                const btn = document.querySelector('button[onclick="generateTestData()"]');
                btn.disabled = true;
                btn.innerText = 'Generating...';

                try {
                    await window.db.saveContact({ name: 'Rahul Sharma', email: 'rahul@example.com', phone: '9876543210', message: 'Hare Krishna! I would like to volunteer.' });
                    await window.db.saveContact({ name: 'Priya Patel', email: 'priya@example.com', phone: '9988776655', message: 'When is the next festival?' });
                    
                    await window.db.saveDonation({ donorName: 'Amit Kumar', amount: 5001, email: 'amit@example.com', purpose: 'Temple Construction' });
                    await window.db.saveDonation({ donorName: 'Sneha Gupta', amount: 1100, email: 'sneha@example.com', purpose: 'Food for Life' });
                    
                    await window.db.saveSubscriber('devotee@example.com');
                    await window.db.saveSubscriber('krishna.bhakta@example.com');
                    
                    await loadData();
                    alert('Test data generated!');
                } catch (error) {
                    console.error('Error generating data:', error);
                    alert('Error generating data');
                } finally {
                    btn.disabled = false;
                    btn.innerText = 'Generate Test Data';
                }
            }
        }
    </script>
</body>
</html>
